generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// enums
enum ProductType {
  BAG
  BACKPACK
  CASE
  SHOPPER
  BELT_BAG
  ORNAMENTS
  ACCESSORY
}

enum ProductGroup {
  BEADS
  WEAVING
}

enum OrderStatus {
  PENDING
  PAID
  FAILED
  CANCELLED
  FULFILLED
}

enum PaymentMethod {
  LIQPAY // online payment
  WAYFORPAY // online payment
  COD // afterpayment
  BANK_TRANSFER // bank transfer
}

// каталог
model Product {
  id           String        @id @default(cuid())
  slug         String        @unique
  name         String
  description  String? // поле ОПИС
  info         String? // поле ІНФО
  dimensions   String? // поле ЗАМІРИ
  type         ProductType
  group        ProductGroup?
  basePriceUAH Int?
  inStock      Boolean       @default(true)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  sortCatalog     Int  @default(0)
  sortSlider      Int?
  

  variants        ProductVariant[]

  @@index([type])
  @@index([group])
  @@index([inStock])
}

model ProductVariant {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id])

  sku         String? @unique
  color       String?
  hex         String?
  image       String?
  inStock     Boolean @default(true)
  priceUAH    Int?
  sortCatalog Int?    @default(0)
  sortBestsellers Int? @default(0)

  images ProductVariantImage[]
  straps ProductVariantStrap[]
  addonsOnVariant ProductVariantAddon[]
}

model ProductVariantImage {
  id        String         @id @default(cuid())
  variantId String
  variant   ProductVariant @relation(fields: [variantId], references: [id])

  url   String
  sort  Int     @default(0)
  hover Boolean @default(false)

  @@index([variantId, sort])
}

model ProductVariantStrap {
  id        String         @id @default(cuid())
  variantId String
  variant   ProductVariant @relation(fields: [variantId], references: [id])

  name         String // назва ремінця біля кружечка
  slug         String? // якщо стане в пригоді (фільтри/аналітика)
  imageUrl     String? // фото ремінця (можемо використовувати і як прев’ю, і як основне)
  mainImageUrl String? // опціонально: головне фото сумки з цим ремінцем
  sort         Int     @default(0)

  @@index([variantId, sort])
}

model ProductAddon {
  id       String  @id @default(cuid())
  name     String
  slug     String  @unique
  imageUrl String?
  priceUAH Int
  active   Boolean @default(true)
  sort     Int     @default(0)

  type      ProductType @default(ACCESSORY)
  inStock   Boolean     @default(true)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  variants ProductVariantAddon[]
}

model ProductVariantAddon {
  id        String  @id @default(cuid())
  variantId String
  variant   ProductVariant @relation(fields: [variantId], references: [id])

  addonId String
  addon   ProductAddon @relation(fields: [addonId], references: [id])

  @@unique([variantId, addonId])
}

model Customer {
  id        String   @id @default(cuid())
  email     String?  @unique
  phone     String?  @unique
  name      String?
  createdAt DateTime @default(now())

  orders Order[]
}

// замовлення
model Order {
  id          String      @id @default(cuid())
  shortNumber Int         @unique @default(autoincrement())
  status      OrderStatus @default(PENDING)
  createdAt   DateTime    @default(now())

  // totals (знімок на момент замовлення)
  subtotalUAH Int
  deliveryUAH Int @default(0)
  discountUAH Int @default(0)
  totalUAH    Int

  // snapshot клієнта (заповнюється з форми)
  customerName       String
  customerSurname    String
  customerPatronymic String?
  customerPhone      String
  customerEmail      String?

  // Нова Пошта (знімок)
  npCityRef       String
  npCityName      String
  npWarehouseRef  String
  npWarehouseName String

  // оплата
  paymentMethod PaymentMethod
  paymentId     String? // external id (wayforpay)
  paymentStatus String? // сирий статус провайдера
  paymentRaw    Json? // payload від провайдера 

  // зв’язки
  items      OrderItem[]
  customerId String?
  customer   Customer?   @relation(fields: [customerId], references: [id])

  @@index([status, createdAt])
  @@index([customerPhone])
}

model OrderItem {
  id      String @id @default(cuid())
  orderId String
  order   Order  @relation(fields: [orderId], references: [id])

  // snapshot товару
  productId String? // посилання на поточний продукт (не обов’язково)
  variantId String? // посилання на варіант (не обов’язково)
  name      String // "Beaded Bag — Pink"
  color     String?
  image     String?
  priceUAH  Int // ціна у момент покупки
  qty       Int // кількість
}
model PreorderLead {
  id           String   @id @default(cuid())
  createdAt    DateTime @default(now())

  // product context
  productId    String
  productSlug  String?
  productName  String
  variantId    String
  variantColor String?
  strapId      String?

  // lead
  contactName  String?
  contact      String
  comment      String?
  source       String?

  @@index([createdAt])
  @@index([productId])
  @@index([variantId])
}